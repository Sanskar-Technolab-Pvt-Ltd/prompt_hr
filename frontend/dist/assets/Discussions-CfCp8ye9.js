import{D as N,E as z,r as C,i as S,o as H,y as T,d as v,e as n,j as w,h as D,f as o,g as d,m as k,k as e,W as I,_ as $,t as u,F as V,v as L,av as A,aG as K,aH as W,n as B,aw as q,L as F,K as Q,H as X,p as Y,aI as J,J as Z,A as ee,aJ as te,M as se}from"./index-OSkjyhkw.js";import{_ as O}from"./UserAvatar-CL8ZQPT_.js";const oe={class:"mt-6"},ae={key:0,class:"flex items-center mb-5"},le={class:"text-lg font-semibold ml-2 text-ink-gray-9"},ne={class:"flex items-center justify-between mb-2"},re={class:"flex items-center text-ink-gray-5"},ie={class:"text-sm ml-2"},de={key:1},ce={class:"flex justify-between mt-2"},j={__name:"DiscussionReplies",props:N({topic:{type:Object,required:!0},singleThread:{type:Boolean,default:!1}},{showTopics:{},showTopicsModifiers:{}}),emits:["update:showTopics"],setup(l){const h=z(l,"showTopics"),b=C(""),r=S("$socket"),x=S("$user"),_=S("$allUsers"),p=C([]),m=C(!1),s=l;H(()=>{r.on("publish_message",t=>{i.reload()}),r.on("update_message",t=>{i.reload()}),r.on("delete_message",t=>{i.reload()}),y()});const i=T({url:"lms.lms.utils.get_discussion_replies",cache:["replies",s.topic],makeParams(t){return{topic:s.topic.name}},auto:!0}),E=T({url:"frappe.client.insert",makeParams(t){return{doc:{doctype:"Discussion Reply",reply:b.value,topic:s.topic.name}}}}),y=()=>{var t;(t=x.data)!=null&&t.is_student?m.value=!0:_.reload({},{onSuccess(f){p.value=Object.values(f).map(a=>({value:a.name,label:a.full_name})),m.value=!0}})},g=()=>{E.submit({},{validate(){if(!b.value)return"Reply cannot be empty"},onSuccess(){b.value="",i.reload()},onError(t){var f;Q({title:"Error",text:((f=t.messages)==null?void 0:f[0])||t,icon:"x",iconClasses:"bg-surface-red-5 text-ink-white rounded-md p-px",position:"top-center",timeout:10})}})},R=T({url:"frappe.client.set_value",makeParams(t){return{doctype:"Discussion Reply",name:t.name,fieldname:"reply",value:t.reply}}}),c=t=>{R.submit({name:t.name,reply:t.reply},{validate(){if(!t.reply)return"Reply cannot be empty"},onSuccess(){t.editable=!1,i.reload()}})},P=T({url:"frappe.client.delete",makeParams(t){return{doctype:"Discussion Reply",name:t.name}}}),U=t=>{P.submit({name:t.name},{onSuccess(){i.reload()}})};return(t,f)=>(n(),v("div",oe,[l.singleThread?w("",!0):(n(),v("div",ae,[d(e($),{variant:"outline",onClick:f[0]||(f[0]=a=>h.value=!0)},{icon:k(()=>[d(e(I),{class:"w-5 h-5 stroke-1.5 text-ink-gray-7"})]),_:1}),o("span",le,u(l.topic.title),1)])),(n(!0),v(V,null,L(e(i).data,(a,G)=>(n(),v("div",null,[o("div",{class:F(["py-3",{"border-b":G+1!=e(i).data.length}])},[o("div",ne,[o("div",re,[d(O,{user:a.user,class:"mr-2"},null,8,["user"]),o("span",null,u(a.user.full_name),1),o("span",ie,u(e(A)(a.creation)),1)]),e(x).data.name==a.owner&&!a.editable?(n(),D(e(W),{key:0,options:[{label:"Edit",onClick(){a.editable=!0}},{label:"Delete",onClick(){U(a)}}]},{default:k(({open:M})=>[d(e(K),{class:"w-4 h-4 stroke-1.5 cursor-pointer"})]),_:2},1032,["options"])):w("",!0),a.editable?(n(),v("div",de,[d(e($),{variant:"ghost",onClick:M=>c(a)},{default:k(()=>[B(u(t.__("Post")),1)]),_:2},1032,["onClick"]),d(e($),{variant:"ghost",onClick:M=>a.editable=!1},{default:k(()=>[B(u(t.__("Discard")),1)]),_:2},1032,["onClick"])])):w("",!0)]),d(e(q),{content:a.reply,onChange:M=>a.reply=M,editable:a.editable||!1,fixedMenu:a.editable||!1,editorClass:a.editable?"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none":"prose-sm"},null,8,["content","onChange","editable","fixedMenu","editorClass"])],2)]))),256)),m.value?(n(),D(e(q),{key:1,class:"mt-5",content:b.value,mentions:p.value,onChange:f[1]||(f[1]=a=>b.value=a),placeholder:"Type your reply here...",fixedMenu:!0,editorClass:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-outline-gray-2 prose-th:border-outline-gray-2 prose-td:relative prose-th:relative prose-th:bg-surface-gray-2 prose-sm max-w-none border border-outline-gray-2 rounded-b-md min-h-[7rem] py-1 px-2"},null,8,["content","mentions"])):w("",!0),o("div",ce,[f[3]||(f[3]=o("span",null,null,-1)),d(e($),{onClick:f[2]||(f[2]=a=>g())},{default:k(()=>[o("span",null,u(t.__("Post")),1)]),_:1})])]))}},ue={class:"flex flex-col gap-4"},pe={class:"mb-1.5 text-sm text-ink-gray-5"},me={__name:"DiscussionModal",props:N({title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0}},{reloadTopics:{},reloadTopicsModifiers:{}}),emits:["update:reloadTopics"],setup(l){const h=z(l,"reloadTopics"),b=l,r=X({title:"",reply:""}),x=T({url:"frappe.client.insert",makeParams(m){return{doc:{doctype:"Discussion Topic",reference_doctype:b.doctype,reference_docname:b.docname,title:r.title}}}}),_=T({url:"frappe.client.insert",makeParams(m){return{doc:{doctype:"Discussion Reply",topic:m.topic,reply:r.reply}}}}),p=m=>{x.submit({},{validate(){if(!r.title)return"Title cannot be empty.";if(!r.reply)return"Reply cannot be empty."},onSuccess(s){_.submit({topic:s.name},{onSuccess(){r.title="",r.reply="",h.value.reload(),m()}})},onError(s){ee("Error",s.message,"x")}})};return(m,s)=>(n(),D(e(Z),{options:{title:e(J)(b.title),size:"2xl",actions:[{label:"Post",variant:"solid",onClick:i=>p(i)}]}},{"body-content":k(()=>[o("div",ue,[o("div",null,[d(e(Y),{modelValue:r.title,"onUpdate:modelValue":s[0]||(s[0]=i=>r.title=i),label:m.__("Title"),type:"text"},null,8,["modelValue","label"])]),o("div",null,[o("div",pe,u(m.__("Details")),1),d(e(q),{content:r.reply,onChange:s[1]||(s[1]=i=>r.reply=i),editable:!0,fixedMenu:!0,editorClass:"prose-sm max-w-none border-b border-x bg-surface-gray-2 rounded-b-md py-1 px-2 min-h-[7rem]"},null,8,["content"])])])]),_:1},8,["options"]))}};function ye(){return window.scrollContainer}const fe={class:"text-xl font-semibold text-ink-gray-9"},ve={key:0},be=["onClick"],ge={class:"text-lg font-semibold mb-1 text-ink-gray-7"},he={class:"flex items-center text-ink-gray-5"},_e={class:"text-sm ml-3"},ke={key:1},Te={key:1},xe={key:2,class:"flex flex-col items-center justify-center border-2 border-dashed mt-5 py-8 rounded-md"},we={class:""},Ce={key:0,class:"font-medium mb-2"},$e={class:"text-ink-gray-5"},Me={__name:"Discussions",props:{title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0},emptyStateTitle:{type:String,default:""},emptyStateText:{type:String,default:"Start a discussion"},singleThread:{type:Boolean,default:!1},scrollToBottom:{type:Boolean,default:!1}},setup(l){const h=C(!0),b=C(null),r=S("$socket"),x=S("$user"),_=C(!1),p=l;H(()=>{x.data&&s.reload(),r.on("new_discussion_topic",y=>{s.refresh()}),p.scrollToBottom&&setTimeout(()=>{m()},100)});const m=()=>{let y=ye();y.scrollTop=y.scrollHeight},s=T({url:"lms.lms.utils.get_discussion_topics",cache:["topics",p.doctype,p.docname],makeParams(){return{doctype:p.doctype,docname:p.docname,single_thread:p.singleThread}}}),i=y=>{h.value=!1,b.value=y},E=()=>{_.value=!0};return(y,g)=>{var R;return n(),v(V,null,[o("div",null,[l.singleThread?w("",!0):(n(),D(e($),{key:0,class:"float-right",onClick:g[0]||(g[0]=c=>E())},{default:k(()=>[B(u(y.__("New {0}").format(e(J)(l.title))),1)]),_:1})),o("div",fe,u(y.__(l.title)),1)]),(R=e(s).data)!=null&&R.length&&!l.singleThread?(n(),v("div",ve,[h.value?(n(!0),v(V,{key:0},L(e(s).data,(c,P)=>(n(),v("div",null,[o("div",{onClick:U=>i(c),class:F(["flex items-center cursor-pointer py-5 w-full",{"border-b":P+1!=e(s).data.length}])},[d(O,{user:c.user,size:"2xl",class:"mr-4"},null,8,["user"]),o("div",null,[o("div",ge,u(c.title),1),o("div",he,[o("span",null,u(c.user.full_name),1),o("span",_e,u(e(A)(c.creation)),1)])])],10,be)]))),256)):(n(),v("div",ke,[d(j,{topic:b.value,showTopics:h.value,"onUpdate:showTopics":g[1]||(g[1]=c=>h.value=c)},null,8,["topic","showTopics"])]))])):l.singleThread&&e(s).data?(n(),v("div",Te,[d(j,{topic:e(s).data,singleThread:l.singleThread},null,8,["topic","singleThread"])])):(n(),v("div",xe,[d(e(te),{class:"w-7 h-7 text-ink-gray-4 stroke-1.5 mr-2"}),o("div",we,[l.emptyStateTitle?(n(),v("div",Ce,u(y.__(l.emptyStateTitle)),1)):w("",!0),o("div",$e,u(y.__(l.emptyStateText)),1)])])),d(me,{modelValue:_.value,"onUpdate:modelValue":g[2]||(g[2]=c=>_.value=c),title:y.__("New {0}").format(l.title),doctype:p.doctype,docname:p.docname,reloadTopics:e(s),"onUpdate:reloadTopics":g[3]||(g[3]=c=>se(s)?s.value=c:null)},null,8,["modelValue","title","doctype","docname","reloadTopics"])],64)}}};export{Me as _};
