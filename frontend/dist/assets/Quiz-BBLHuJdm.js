import{i as ke,r as q,H as V,x as be,y as $,a as we,av as xe,w as R,d as n,j as m,k as t,e as o,f as r,t as i,g as S,h as f,bf as D,cb as te,m as w,_ as T,F as Y,v as j,cc as se,cd as ae,ce as oe,bg as qe,p as Se,O as ne,aw as Ce,K as U,A as ze,Y as re}from"./index-OSkjyhkw.js";import{f as $e}from"./ListView-yKC6cFSr.js";import{_ as Te}from"./ProgressBar-Bazu_17j.js";const Me={key:0},Ne={class:"bg-surface-blue-2 space-y-1 py-2 px-2 mb-4 rounded-md text-sm text-ink-blue-3"},Ie={class:"leading-5"},Qe={key:0,class:"leading-5"},Ee={key:1,class:"leading-5"},Pe={key:2,class:"leading-relaxed"},Ae={key:3,class:"leading-5"},Le={key:0,class:"flex flex-col space-x-1 my-4"},Oe={class:"mb-2"},Ve={class:""},Re={class:"font-semibold"},De={key:1},Ye={class:"border text-center p-20 rounded text-sm max-w-md mx-auto"},je={class:"font-semibold text-lg text-ink-gray-9 mb-4"},Ue={class:"mb-2"},Be={class:"mb-4"},He={key:1,class:"leading-5 text-ink-gray-7 mb-2"},Je={key:2},Fe={key:0,class:"border rounded-md p-5"},Ke={class:"flex justify-between"},Xe={class:"text-sm text-ink-gray-5"},Ge={class:"mr-2"},We={class:"text-ink-gray-9 text-sm font-semibold item-left"},Ze=["innerHTML"],et={key:0,class:"flex items-center bg-surface-gray-3 rounded-md p-3 mt-4 w-full cursor-pointer focus:border-blue-600"},tt=["name","onChange"],st=["name","onChange"],at={key:0},ot=["innerHTML"],nt={key:1},rt={key:0},lt={key:2},it={class:"flex items-center justify-between mt-4"},ut={class:"text-sm text-ink-gray-5"},dt={key:3,class:"border rounded-md p-20 text-center space-y-2"},ct={class:"text-lg font-semibold text-ink-gray-9"},mt={key:0,class:"leading-5 text-ink-gray-7"},_t={key:1},pt={key:4,class:"mt-10"},yt={__name:"Quiz",props:{quizName:{type:String,required:!0}},setup(le){const ie=ke("$user"),p=q(0),M=q(""),N=q(""),I=q(""),h=V([0,0,0,0]),d=V([]);let g=V([]);const x=q(null),C=q(0);let E=null;const Q=be(),P=le,a=$({url:"frappe.client.get",makeParams(e){return{doctype:"LMS Quiz",name:P.quizName}},cache:["quiz",P.quizName],auto:!0,transform(e){e.duration=parseInt(e.duration)},onSuccess(e){A(),B()}}),A=()=>{let e=a.data;e.shuffle_questions?(g=me(e.questions),e.limit_questions_to&&(g=g.slice(0,e.limit_questions_to))):g=e.questions},B=()=>{a.data.duration&&(C.value=a.data.duration*60)},ue=()=>{E=setInterval(()=>{C.value--,C.value==0&&(clearInterval(E),K())},1e3)},de=e=>{const s=Math.floor(e/3600).toString().padStart(2,"0"),u=Math.floor(e%3600/60).toString().padStart(2,"0"),_=(e%60).toString().padStart(2,"0");return s!="00"?`${s}:${u}:${_}`:`${u}:${_}`},ce=we(()=>C.value/(a.data.duration*60)*100),me=e=>{for(let s=e.length-1;s>0;s--){const u=Math.floor(Math.random()*(s+1));[e[s],e[u]]=[e[u],e[s]]}return e},v=$({url:"frappe.client.get_list",makeParams(e){var s,u;return{doctype:"LMS Quiz Submission",filters:{member:(s=ie.data)==null?void 0:s.name,quiz:(u=a.data)==null?void 0:u.name},fields:["name","creation","score","score_out_of","percentage","passing_percentage"],order_by:"creation desc"}},transform(e){e.forEach((s,u)=>{s.creation=xe(s.creation),s.idx=u+1})}});R(()=>a.data,()=>{a.data&&A(),a.data&&a.data.max_attempts&&(v.reload(),G())});const k=$({url:"prompt_hr.py.lms.quiz_summary",makeParams(e){return{quiz:a.data.name,results:localStorage.getItem(a.data.title),phone_number:N.value,password:I.value}}}),l=$({url:"lms.lms.utils.get_question_details",makeParams(e){return{question:M.value}}});R(p,e=>{e>0&&(M.value=a.data.questions[e-1].question,l.reload())}),R(()=>P.quizName,e=>{e&&a.reload()});const _e=async()=>{try{window.onbeforeunload=function(s){s.preventDefault(),s.returnValue="Are you sure you want to leave? Your quiz progress may be lost."};const e=await re("prompt_hr.py.lms.start_quiz_rituals",{phone:N.value,password:I.value,quiz_id:a.data.name});e==!0?(p.value=1,localStorage.removeItem(a.data.title),a.data.duration&&ue()):U({title:e.message,icon:"alert-circle",iconClasses:"text-red-600 bg-red-100 rounded-full",position:"top-center"})}catch{U({title:"Something went wrong. Please try again later!",icon:"alert-circle",iconClasses:"text-red-600 bg-red-100 rounded-full",position:"top-center"})}},H=e=>{l.data.multiple||h.splice(0,h.length,0,0,0,0),h[e-1]=h[e-1]?0:1},J=()=>{let e=[];return l.data.type=="Choices"?h.forEach((u,_)=>{h[_]&&e.push(l.data[`option_${_+1}`])}):e.push(x.value),e},L=()=>{let e=J();if(!e.length){U({title:"Please select an option",icon:"alert-circle",iconClasses:"text-yellow-600 bg-yellow-100 rounded-full",position:"top-center"});return}$({url:"lms.lms.doctype.lms_quiz.lms_quiz.check_answer",params:{question:M.value,type:l.data.type,answers:JSON.stringify(e)},auto:!0,onSuccess(s){l.data.type=="Choices"?h.forEach((_,y)=>{_?d[y]=_&&s[y]:s[y]==2?d[y]=2:d[y]=void 0}):d.push(s),O(),a.data.show_answers||F()}})},O=()=>{let e=JSON.parse(localStorage.getItem(a.data.title)),s={question_name:M.value,answer:J().join(),is_correct:d.filter(u=>u!=null)};e?e.push(s):e=[s],localStorage.setItem(a.data.title,JSON.stringify(e))},pe=()=>{var e,s;!a.data.show_answers&&((e=l.data)==null?void 0:e.type)!="Open Ended"?L():(((s=l.data)==null?void 0:s.type)=="Open Ended"&&O(),F())},F=()=>{p.value!=a.data.questions.length&&(p.value=p.value+1,h.splice(0,h.length,0,0,0,0),d.length=0,x.value=null)},K=()=>{if(!a.data.show_answers){l.data.type=="Open Ended"?O():L(),setTimeout(()=>{window.onbeforeunload=null,X()},500);return}X()},X=()=>{k.submit({},{onSuccess(e){fe(),a.data&&a.data.max_attempts&&v.reload(),a.data.duration&&clearInterval(E)},onError(e){var u;if(((e==null?void 0:e.message)||"").includes("MaximumAttemptsExceededError")){const _=((u=e.messages)==null?void 0:u[0])||e;ze(__("Error"),__(_),"x"),setTimeout(()=>{window.location.reload()},3e3)}}})},G=()=>{p.value=0,h.splice(0,h.length,0,0,0,0),d.length=0,k.reset(),A(),B()},he=e=>e.type=="Choices"?e.multiple?__("Choose all answers that apply"):__("Choose one answer"):__("Type your answer"),fe=()=>{Q.currentRoute.value.name=="Lesson"&&re("lms.lms.api.mark_lesson_progress",{course:Q.currentRoute.value.params.courseName,chapter_number:Q.currentRoute.value.params.chapterNumber,lesson_number:Q.currentRoute.value.params.lessonNumber})},ge=()=>[{label:"No.",key:"idx"},{label:"Date",key:"creation"},{label:"Score",key:"score",align:"center"},{label:"Score out of",key:"score_out_of",align:"center"},{label:"Percentage",key:"percentage",align:"center"}];return(e,s)=>{var u,_,y,W,Z,ee;return t(a).data?(o(),n("div",Me,[r("div",Ne,[r("div",Ie,i(e.__("This quiz consists of {0} questions.").format(t(g).length)),1),(u=t(a).data)!=null&&u.duration?(o(),n("div",Qe,i(e.__("Please ensure that you complete all the questions in {0} minutes.").format(t(a).data.duration)),1)):m("",!0),(_=t(a).data)!=null&&_.duration?(o(),n("div",Ee,i(e.__("If you fail to do so, the quiz will be automatically submitted when the timer ends.")),1)):m("",!0),t(a).data.passing_percentage?(o(),n("div",Pe,i(e.__("You will have to get {0}% correct answers in order to pass the quiz.").format(t(a).data.passing_percentage)),1)):m("",!0),t(a).data.max_attempts?(o(),n("div",Ae,i(e.__("You can attempt this quiz {0}.").format(t(a).data.max_attempts==1?"1 time":`${t(a).data.max_attempts} times`)),1)):m("",!0)]),t(a).data.duration?(o(),n("div",Le,[r("div",Oe,[r("span",Ve,i(e.__("Time"))+": ",1),r("span",Re,i(de(C.value)),1)]),S(Te,{progress:ce.value},null,8,["progress"])])):m("",!0),p.value==0?(o(),n("div",De,[r("div",Ye,[r("div",je,i(t(a).data.title),1),r("div",Ue,[D(r("input",{"onUpdate:modelValue":s[0]||(s[0]=b=>N.value=b),type:"text",placeholder:"Phone Numberrrrrr",class:"w-5/6 px-3 py-2 border rounded-md"},null,512),[[te,N.value]])]),r("div",Be,[D(r("input",{"onUpdate:modelValue":s[1]||(s[1]=b=>I.value=b),type:"password",placeholder:"Password",class:"w-5/6 px-3 py-2 border rounded-md"},null,512),[[te,I.value]])]),!t(a).data.max_attempts||((y=t(v).data)==null?void 0:y.length)<t(a).data.max_attempts?(o(),f(t(T),{key:0,onClick:_e,class:"mb-2"},{default:w(()=>[r("span",null,i(e.__("Start")),1)]),_:1})):(o(),n("div",He,i(e.__("You have already exceeded the maximum number of attempts allowed for this quiz.")),1))])])):t(k).data?(o(),n("div",dt,[r("div",ct,i(e.__("Quiz Summary")),1),t(k).data.is_open_ended?(o(),n("div",mt,i(e.__("Your submission has been successfully saved. The instructor will review and grade it shortly, and you'll be notified of your final result.")),1)):(o(),n("div",_t,i(e.__("You got {0}% correct answers with a score of {1} out of {2}").format(Math.ceil(t(k).data.percentage),t(k).data.score,t(k).data.score_out_of)),1)),!t(a).data.max_attempts||((W=t(v))==null?void 0:W.data.length)<t(a).data.max_attempts?(o(),f(t(T),{key:2,onClick:s[7]||(s[7]=b=>G()),class:"mt-2"},{default:w(()=>[r("span",null,i(e.__("Try Again")),1)]),_:1})):m("",!0)])):(o(),n("div",Je,[(o(!0),n(Y,null,j(t(g),(b,ye)=>(o(),n("div",null,[ye==p.value-1&&t(l).data?(o(),n("div",Fe,[r("div",Ke,[r("div",Xe,[r("span",Ge,i(e.__("Question {0}").format(p.value))+": ",1),r("span",null,i(he(t(l).data)),1)]),r("div",We,i(b.marks)+" "+i(b.marks==1?e.__("Mark"):e.__("Marks")),1)]),r("div",{class:"text-ink-gray-9 font-semibold mt-2 leading-5",innerHTML:t(l).data.question},null,8,Ze),t(l).data.type=="Choices"?(o(),n(Y,{key:0},j(4,c=>r("div",null,[t(l).data[`option_${c}`]?(o(),n("label",et,[!d.length&&!t(l).data.multiple?(o(),n("input",{key:0,type:"radio",name:encodeURIComponent(t(l).data.question),class:"w-3.5 h-3.5 text-ink-gray-9 focus:ring-outline-gray-modals",onChange:z=>H(c)},null,40,tt)):!d.length&&t(l).data.multiple?(o(),n("input",{key:1,type:"checkbox",name:encodeURIComponent(t(l).data.question),class:"w-3.5 h-3.5 text-ink-gray-9 rounded-sm focus:ring-outline-gray-modals",onChange:z=>H(c)},null,40,st)):t(a).data.show_answers?(o(!0),n(Y,{key:2},j(d,(z,ve)=>(o(),n("div",null,[c-1==ve?(o(),n("div",at,[z==1?(o(),f(t(se),{key:0,class:"w-4 h-4 text-ink-green-2"})):z==2?(o(),f(t(ae),{key:1,class:"w-4 h-4 text-ink-green-2"})):z==0?(o(),f(t(oe),{key:2,class:"w-4 h-4 text-ink-red-3"})):(o(),f(t(ae),{key:3,class:"w-4 h-4"}))])):m("",!0)]))),256)):m("",!0),r("span",{class:"ml-2",innerHTML:t(l).data[`option_${c}`]},null,8,ot)])):m("",!0),t(l).data[`explanation_${c}`]?D((o(),n("div",{key:1,class:"mt-2 text-xs"},i(t(l).data[`explanation_${c}`]),513)),[[qe,d.length]]):m("",!0)])),64)):t(l).data.type=="User Input"?(o(),n("div",nt,[S(t(Se),{modelValue:x.value,"onUpdate:modelValue":s[2]||(s[2]=c=>x.value=c),type:"textarea",disabled:!!d.length,class:"my-2"},null,8,["modelValue","disabled"]),d.length?(o(),n("div",rt,[d[0]?(o(),f(t(ne),{key:0,label:e.__("Correct"),theme:"green"},{prefix:w(()=>[S(t(se),{class:"w-4 h-4 text-ink-green-2 mr-1"})]),_:1},8,["label"])):(o(),f(t(ne),{key:1,theme:"red",label:e.__("Incorrect")},{prefix:w(()=>[S(t(oe),{class:"w-4 h-4 text-ink-red-3 mr-1"})]),_:1},8,["label"]))])):m("",!0)])):(o(),n("div",lt,[S(t(Ce),{class:"mt-4",content:x.value,onChange:s[3]||(s[3]=c=>x.value=c),editable:!0,fixedMenu:!0,editorClass:"prose-sm max-w-none border-b border-x bg-surface-gray-2 rounded-b-md py-1 px-2 min-h-[7rem]"},null,8,["content"])])),r("div",it,[r("div",ut,i(e.__("Question {0} of {1}").format(p.value,t(g).length)),1),t(a).data.show_answers&&!d.length&&t(l).data.type!="Open Ended"?(o(),f(t(T),{key:0,onClick:s[4]||(s[4]=c=>L())},{default:w(()=>[r("span",null,i(e.__("Check")),1)]),_:1})):p.value!=t(g).length?(o(),f(t(T),{key:1,onClick:s[5]||(s[5]=c=>pe())},{default:w(()=>[r("span",null,i(e.__("Next")),1)]),_:1})):(o(),f(t(T),{key:2,onClick:s[6]||(s[6]=c=>K())},{default:w(()=>[r("span",null,i(e.__("Submit")),1)]),_:1}))])])):m("",!0)]))),256))])),t(a).data.show_submission_history&&((Z=t(v))!=null&&Z.data)&&t(v).data.length>0?(o(),n("div",pt,[S(t($e),{columns:ge(),rows:(ee=t(v))==null?void 0:ee.data,"row-key":"name",options:{selectable:!1,showTooltip:!1,emptyState:{title:e.__("No Quiz submissions found")}}},null,8,["columns","rows","options"])])):m("",!0)])):m("",!0)}}};export{yt as _};
